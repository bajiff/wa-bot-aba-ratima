// ? index.js - FIXED FOR GROUP CHAT & OPTIMIZED
import fs from 'fs';
import qrcode from 'qrcode-terminal';
import { GoogleGenerativeAI } from '@google/generative-ai';
import 'dotenv/config';
import pkg from 'whatsapp-web.js';
const { Client, LocalAuth } = pkg;

// --- 1. KONFIGURASI GEMINI AI (STRICT MODEL) ---
const genAI = new GoogleGenerativeAI(process.env.API_KEY);

// Menggunakan model sesuai permintaan (Lite/Flash)
const model = genAI.getGenerativeModel({ 
    model: "gemini-3-flash-preview", //  DO NOT CHANGE
    generationConfig: {
        temperature: 0.3,       
        maxOutputTokens: 800,   
    }
});

// --- 2. SETUP LOGGER (DATA KUANTITATIF) ---
const LOG_FILE = 'data-penelitian.csv';

const logResearchData = (question, answer, duration) => {
    if (!fs.existsSync(LOG_FILE)) {
        fs.writeFileSync(LOG_FILE, 'Timestamp,Pertanyaan,Jawaban,Waktu_Proses_ms\n');
    }
    const cleanQ = question ? question.replace(/[\n,"]/g, ' ') : ''; 
    const cleanA = answer ? answer.replace(/[\n,"]/g, ' ') : '';
    const time = new Date().toISOString();
    
    const row = `${time},"${cleanQ}","${cleanA}",${duration}\n`;
    fs.appendFileSync(LOG_FILE, row);
};

// --- 3. IN-MEMORY DATABASE (CACHE) ---
let PUSKESMAS_DATA_CONTEXT = "";

try {
    console.log("ðŸ“‚ Membaca Database Puskesmas ke RAM...");
    const rawData = fs.readFileSync('data-puskesmas-umum.json', 'utf8');
    const jsonData = JSON.parse(rawData);
    PUSKESMAS_DATA_CONTEXT = JSON.stringify(jsonData); 
    console.log("âœ… Database Siap!");
} catch (error) {
    console.error("âŒ FATAL: Gagal memuat database.", error);
    process.exit(1);
}

// --- 4. SYSTEM INSTRUCTION (DO NOT CHANGE) ---
// Sesuai original file 
const SYSTEM_INSTRUCTION = `
PERAN: Anda adalah "WaPusU", Asisten Digital Cerdas dari Puskesmas Umum.
TUGAS UTAMA:
1. Jika User menyapa (Halo/P/Assalamualaikum) -> Berikan salam pembuka dan tawarkan bantuan.
2. Jika User bertanya -> Jawab berdasarkan DATA JSON yang dilampirkan.
3. Greeting: Halo ðŸ‘‹!
Saya WaPusU, Chatbot WhatsApp Puskesmas Umum. Saya siap membantu Anda dengan informasi seputar Informasi dan berikan point-point yang bisa anda jelaskan agar user tidak bingung untuk bertanya.
ATURAN FORMAT & GAYA BAHASA:
1. Gunakan Bahasa Indonesia formal, ramah, dan solutif.
2. Gunakan Emoji yang relevan.
3. **FORMAT WHATSAPP:**
   - Gunakan tanda bintang (*) untuk menebalkan poin penting.
   - Gunakan strip (-) untuk daftar/list.
- **WAJIB:** Berikan jarak antar paragraf (Enter 2x) agar tulisan tidak menumpuk.

BATASAN (STRICT):
- JANGAN MENGARANG / HALUSINASI.
Jawaban harus 100% bersumber dari DATA JSON.
- Jika data tidak ditemukan, JANGAN menebak.
Jawablah persis dengan kalimat ini:
  "ðŸ¤– Mohon maaf, informasi tersebut belum tersedia dalam sistem kami. Silakan hubungi Admin (Pak Mey) di 0855-2222-4321 untuk informasi lebih lanjut."
`;

// --- 5. SETUP CLIENT WHATSAPP ---
const client = new Client({
    authStrategy: new LocalAuth(),
    puppeteer: {
        headless: true,
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--disable-gpu'
        ]
    }
});

client.on('qr', (qr) => qrcode.generate(qr, { small: true }));
client.on('ready', () => console.log('[INFO] Bot Siap Melayani!'));

// --- 6. LOGIKA PESAN UTAMA ---
client.on('message', async msg => {
    // Filter status broadcast
    if (msg.body === 'status@broadcast') return;

    try {
        const chat = await msg.getChat();

        // === FILTER GROUP CHAT (REVISI PENTING) ===
        if (chat.isGroup) {
            // Opsional: Log ke console agar kita tahu ada yang mencoba
            console.log(`[BLOCKED] Group Chat terdeteksi dari ${msg.from}. Mengabaikan.`);
            return; // STOP DI SINI. Jangan proses apapun.
        }
        // ===========================================

        const startTime = Date.now();
        console.log(`[USER] ${msg.from}: ${msg.body}`);

        // Construct Prompt (Context Injection)
        const prompt = `
        ${SYSTEM_INSTRUCTION}

        === DATA PUSKESMAS UMUM (SUMBER KEBENARAN) ===
        ${PUSKESMAS_DATA_CONTEXT}
        =======================================

        PERTANYAAN USER: "${msg.body}"
        JAWABAN:`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();

        // Reply ke user
        await msg.reply(text);

        const endTime = Date.now();
        logResearchData(msg.body, text, endTime - startTime);
        console.log(`[BOT] Terkirim (${endTime - startTime}ms)`);

    } catch (error) {
        console.error('[ERROR]', error);
    }
});

client.initialize();